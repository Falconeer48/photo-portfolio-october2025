<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Upload - Enhanced with Uppy.js</title>
    
    <!-- Uppy.js CSS -->
    <link href="https://releases.transloadit.com/uppy/v3.0.0/uppy.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .upload-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .upload-stats {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .upload-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-info { color: #007bff; }
    </style>
</head>
<body>
    <div class="upload-container">
        <h1>üì∏ Enhanced Photo Upload</h1>
        <p>Upload your photos with multi-connection support for faster transfers</p>
        
        <!-- Uppy Dashboard -->
        <div id="uppy-dashboard"></div>
        
        <!-- Upload Statistics -->
        <div class="upload-stats">
            <h3>üìä Upload Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="total-files">0</div>
                    <div class="stat-label">Total Files</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-size">0 MB</div>
                    <div class="stat-label">Total Size</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avg-speed">0 Mbps</div>
                    <div class="stat-label">Avg Speed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="connections">4</div>
                    <div class="stat-label">Connections</div>
                </div>
            </div>
        </div>
        
        <!-- Upload Log -->
        <div class="upload-log">
            <h3>üìù Upload Log</h3>
            <div id="upload-log-content">
                <div class="log-entry log-info">Ready to upload photos...</div>
            </div>
        </div>
    </div>

    <!-- Uppy.js JavaScript -->
    <script src="https://releases.transloadit.com/uppy/v3.0.0/uppy.min.js"></script>
    
    <script>
        // Configuration
        const UPLOAD_ENDPOINT = 'http://192.168.50.243:3000/api/upload';
        const CHUNK_SIZE = 1024 * 1024; // 1MB chunks
        const SIMULTANEOUS_UPLOADS = 4; // 4 parallel uploads
        const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB max per file
        
        // Initialize Uppy
        const uppy = new Uppy.Uppy({
            debug: true,
            autoProceed: false,
            restrictions: {
                maxFileSize: MAX_FILE_SIZE,
                maxNumberOfFiles: 20,
                allowedFileTypes: ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.tiff', '.bmp']
            },
            meta: {
                category: 'photos',
                timestamp: new Date().toISOString()
            }
        })
        .use(Uppy.Dashboard, {
            target: '#uppy-dashboard',
            inline: true,
            height: 400,
            showProgressDetails: true,
            proudlyDisplayPoweredByUppy: false,
            note: 'Photos up to 50MB each, up to 20 files at once'
        })
        .use(Uppy.XHRUpload, {
            endpoint: UPLOAD_ENDPOINT,
            fieldName: 'file',
            chunkSize: CHUNK_SIZE,
            simultaneousUploads: SIMULTANEOUS_UPLOADS,
            headers: {
                'X-Upload-Source': 'uppy-enhanced'
            },
            getResponseData: (responseText, response) => {
                try {
                    return JSON.parse(responseText);
                } catch (e) {
                    return { success: true };
                }
            }
        });

        // Upload statistics
        let uploadStats = {
            totalFiles: 0,
            totalSize: 0,
            totalTime: 0,
            totalUploaded: 0,
            startTime: null
        };

        // Log function
        function addLog(message, type = 'info') {
            const logContent = document.getElementById('upload-log-content');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        // Update statistics display
        function updateStats() {
            document.getElementById('total-files').textContent = uploadStats.totalFiles;
            document.getElementById('total-size').textContent = (uploadStats.totalSize / 1024 / 1024).toFixed(1) + ' MB';
            document.getElementById('connections').textContent = SIMULTANEOUS_UPLOADS;
            
            if (uploadStats.totalTime > 0) {
                const avgSpeed = (uploadStats.totalUploaded / uploadStats.totalTime) * 8 / 1024 / 1024; // Mbps
                document.getElementById('avg-speed').textContent = avgSpeed.toFixed(1) + ' Mbps';
            }
        }

        // Event handlers
        uppy.on('file-added', (file) => {
            uploadStats.totalFiles++;
            uploadStats.totalSize += file.size;
            updateStats();
            addLog(`Added: ${file.name} (${(file.size / 1024 / 1024).toFixed(1)} MB)`, 'info');
        });

        uppy.on('file-removed', (file) => {
            uploadStats.totalFiles--;
            uploadStats.totalSize -= file.size;
            updateStats();
            addLog(`Removed: ${file.name}`, 'info');
        });

        uppy.on('upload', () => {
            uploadStats.startTime = Date.now();
            addLog(`Starting upload of ${uploadStats.totalFiles} files...`, 'info');
        });

        uppy.on('upload-progress', (file, progress) => {
            if (progress.bytesUploaded > 0) {
                uploadStats.totalUploaded = progress.bytesUploaded;
                uploadStats.totalTime = (Date.now() - uploadStats.startTime) / 1000;
                updateStats();
            }
        });

        uppy.on('upload-success', (file, response) => {
            addLog(`‚úÖ Successfully uploaded: ${file.name}`, 'success');
        });

        uppy.on('upload-error', (file, error) => {
            addLog(`‚ùå Failed to upload: ${file.name} - ${error.message}`, 'error');
        });

        uppy.on('complete', (result) => {
            const successful = result.successful.length;
            const failed = result.failed.length;
            
            if (failed === 0) {
                addLog(`üéâ All ${successful} files uploaded successfully!`, 'success');
            } else {
                addLog(`‚ö†Ô∏è Upload complete: ${successful} successful, ${failed} failed`, 'error');
            }
            
            // Reset stats
            uploadStats = {
                totalFiles: 0,
                totalSize: 0,
                totalTime: 0,
                totalUploaded: 0,
                startTime: null
            };
            updateStats();
        });

        // Connection count adjustment
        function adjustConnections(count) {
            uppy.getPlugin('XHRUpload').setOptions({
                simultaneousUploads: count
            });
            document.getElementById('connections').textContent = count;
            addLog(`Adjusted to ${count} simultaneous connections`, 'info');
        }

        // Add connection controls
        const connectionControls = document.createElement('div');
        connectionControls.innerHTML = `
            <h4>üîß Connection Settings</h4>
            <button onclick="adjustConnections(2)">2 Connections</button>
            <button onclick="adjustConnections(4)">4 Connections</button>
            <button onclick="adjustConnections(8)">8 Connections</button>
            <button onclick="adjustConnections(16)">16 Connections</button>
        `;
        connectionControls.style.marginTop = '20px';
        connectionControls.style.padding = '15px';
        connectionControls.style.backgroundColor = '#f8f9fa';
        connectionControls.style.borderRadius = '4px';
        
        document.querySelector('.upload-container').appendChild(connectionControls);

        // Initialize stats display
        updateStats();
        addLog('Uppy.js initialized with multi-connection support', 'info');
    </script>
</body>
</html>

